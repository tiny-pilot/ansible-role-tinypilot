---
# TinyPilot Pro has two nginx configuration files, whereas TinyPilot Community
# has just one. Remove the extra Pro file otherwise nginx will fail due to the
# extra file if the user downgrades from Pro to free.
- name: remove stray conf file from TinyPilot Pro
  file:
    path: /etc/nginx/sites-enabled/tinypilot.http.conf
    state: absent

- name: import nginx role
  import_role:
    name: ansible-role-nginx
  vars:
    nginx_extra_http_options: |
      # If we receive X-Forwarded-Proto, pass it through; otherwise, pass along the
      # scheme used to connect to this server
      map $http_x_forwarded_proto $proxy_x_forwarded_proto {
        default $http_x_forwarded_proto;
        ''      $scheme;
      }
      
      # If we receive X-Forwarded-Port, pass it through; otherwise, pass along the
      # server port the client connected to
      map $http_x_forwarded_port $proxy_x_forwarded_port {
        default $http_x_forwarded_port;
        ''      $server_port;
      }
      
      # If we receive Upgrade, set Connection to "upgrade"; otherwise, delete any
      # Connection header that may have been passed to this server
      map $http_upgrade $proxy_connection {
        default upgrade;
        '' close;
      }
    nginx_upstreams:
      - name: tinypilot
        servers:
          - "{{ tinypilot_interface }}:{{ tinypilot_port }} fail_timeout=1s max_fails=600"
      - name: ustreamer
        servers:
          - "{{ ustreamer_interface }}:{{ ustreamer_port }} fail_timeout=1s max_fails=600"
      - name: janus-ws
        servers:
          - "{{ janus_ws_ip }}:{{ janus_ws_port }} fail_timeout=1s max_fails=600"
    nginx_vhosts:
      - listen: "{{ tinypilot_external_port }} default_server"
        server_name: "tinypilot"
        root: "{{ tinypilot_dir }}"
        index: "index.html"
        extra_parameters: |
          proxy_buffers 16 16k;
          proxy_buffer_size 16k;
          proxy_set_header Host $http_host;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection $proxy_connection;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $proxy_x_forwarded_proto;
          proxy_set_header X-Forwarded-Port $proxy_x_forwarded_port;
          proxy_http_version 1.1;

          location /state {
            proxy_pass http://ustreamer;
          }
          location /stream {
            postpone_output 0;
            proxy_buffering off;
            proxy_ignore_headers X-Accel-Buffering;
            proxy_pass http://ustreamer;
          }
          location /snapshot {
            proxy_pass http://ustreamer;
          }
          location /janus/ws {
            proxy_pass http://janus-ws;
          }
          location / {
            proxy_pass http://tinypilot;
          }
          location ~* ^/.+\.(html|js|js.map|css|woff|woff2)$ {
            root "{{ tinypilot_dir }}/app/static";

            # We cache assets to prevent the browser from making redundant
            # requests to the same files while loading the page. (Observed on
            # Chrome 91.) We don’t want caching otherwise, though, in order to
            # avoid stale files after users update their device. Note, that in
            # addition to `max-age`, the browser’s caching behaviour is relative
            # to the `Last-Modified` header, so we make that seem recent.
            add_header Last-Modified $date_gmt;
            add_header Cache-Control 'public, max-age=10s';
          }
          location ~* ^/.+\.(jpg|jpeg|png|ico)$ {
            root "{{ tinypilot_dir }}/app/static";
          }
    nginx_remove_default_vhost: true
