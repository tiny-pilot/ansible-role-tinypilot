---
- name: check if OS is Raspberry Pi OS
  set_fact:
    tinypilot_is_os_raspbian: "{{ ansible_lsb.id is defined and ansible_lsb.id == 'Raspbian' }}"

- name: choose the default version of uStreamer to install
  set_fact:
    ustreamer_repo_version: "{{ ustreamer_repo_version_modern }}"

- name: override the target version of uStreamer with a legacy version for compatibility
  set_fact:
    ustreamer_repo_version: "{{ ustreamer_repo_version_legacy }}"
  when: tinypilot_is_os_raspbian and
          ((ansible_distribution_major_version | int) <= 10)

# Apply a workaround so that the default variables in this role take precedence
# over the default variables in the child uStreamer role. This technique is
# based on this example:
# https://github.com/kzap/ansible-parent-role-defaults-example
- name: collect uStreamer role variables to override
  set_fact:
    ustreamer_overrides: "{{ ustreamer_overrides | default({}) | combine({ item: lookup('vars', item) }) }}"
  when: lookup('vars', item, default='UNDEFINED_VARIABLE') != 'UNDEFINED_VARIABLE'
  loop:
    - ustreamer_interface
    - ustreamer_port
    - ustreamer_repo
    - ustreamer_h264_sink
    - ustreamer_h264_sink_mode
    - ustreamer_h264_sink_rm

- name: import uStreamer role
  include_role:
    name: ansible-role-ustreamer
  vars:
      ustreamer_interface: "{{ ustreamer_overrides.ustreamer_interface }}"
      ustreamer_port: "{{ ustreamer_overrides.ustreamer_port }}"
      ustreamer_repo: "{{ ustreamer_overrides.ustreamer_repo }}"
      ustreamer_h264_sink: "{{ ustreamer_overrides.ustreamer_h264_sink }}"
      ustreamer_h264_sink_mode: "{{ ustreamer_overrides.ustreamer_h264_sink_mode }}"
      ustreamer_h264_sink_rm: "{{ ustreamer_overrides.ustreamer_h264_sink_rm }}"
